================================================================================
OPUS CODE REVIEW — NiftyQuant / Midas Algo Trading System
================================================================================
Date: 2026-02-13
Reviewer: Claude Opus 4.6
Test Suite: 51/51 passing
Current Phase: Phase 4 (Backtesting Engine) per PLAN.md
================================================================================

TABLE OF CONTENTS
─────────────────
  1. Executive Summary
  2. Severity Counts
  3. CRITICAL Findings (Fix Before Any Live/Paper Trading)
  4. HIGH Findings (Fix Before Phase 5)
  5. MEDIUM Findings
  6. LOW Findings
  7. Test Coverage Gaps
  8. PLAN.md Compliance Audit
  9. Architecture & Design Issues
 10. Recommended Fix Priority

================================================================================
1. EXECUTIVE SUMMARY
================================================================================

The codebase has solid foundations — clean module separation, a thoughtful
regime classification system, and a well-structured strategy/backtest
framework. However, it is NOT production-ready. There are critical issues
that would cause real financial losses if deployed:

  - The backtest engine has LOOKAHEAD BIAS (signals computed using the
    same bar's close that fills execute at)
  - The cost model is ~26% too optimistic (missing STT, GST, exchange
    charges, stamp duty, SEBI fees)
  - The circuit breaker EXISTS but is DEAD CODE — not wired into any
    execution path
  - Iron condor has NO exit conditions (50% profit, max loss, DTE=1)
  - Options positions are valued at UNDERLYING PRICE instead of option
    premium, making the entire equity curve meaningless for options strategies
  - NaN inputs to the regime classifier silently produce wrong classifications
  - No Monte Carlo / anti-overfitting checks exist (required by PLAN.md Phase 4)

Total findings: 11 CRITICAL, 38 HIGH, 62 MEDIUM, 45 LOW

================================================================================
2. SEVERITY COUNTS BY MODULE
================================================================================

Module                  CRIT  HIGH   MED   LOW   Total
────────────────────    ────  ────  ────  ────   ─────
Data Layer (src/data)      3     8    14    10      35
Regime (src/regime)        1     3     5     4      13
Signals (src/signals)      0     3    10     7      20
Strategies                 1     4     6     4      15
Backtest Engine            2     6     5     3      16
Execution/Paper            0     3     4     3      10
Risk/Circuit Breaker       2     4     3     2      11
Scripts                    1     3     5     4      13
Project Structure          1     4    10     8      23
────────────────────    ────  ────  ────  ────   ─────
TOTAL                     11    38    62    45     156

================================================================================
3. CRITICAL FINDINGS
================================================================================

C-01 | BACKTEST LOOKAHEAD BIAS
     | File: src/backtest/engine.py:70-86
     | The engine computes regime signals using `bars.iloc[:i+1]` (including
     | bar i's close), then fills orders at bar i's close price. This means
     | the strategy sees the close price BEFORE deciding to trade at that
     | price — classic lookahead bias.
     | FIX: Compute signals on bars.iloc[:i] (exclude current bar), fill at
     | bar i's open or close.

C-02 | COST MODEL MISSING 5 OF 7 COST COMPONENTS
     | File: src/backtest/simulator.py:16-17,41
     | Only brokerage (₹20) and slippage (0.05%) are modeled.
     | MISSING: STT (0.0125% sell), exchange charges (0.053%), GST (18% on
     | brokerage+exchange), SEBI fee (0.0001%), stamp duty (0.003% buy).
     | Per PLAN.md example: actual cost ~₹31/leg vs modeled ~₹23/leg = 26%
     | underestimate. For iron condor round-trip (8 txns): ~₹66 gap.

C-03 | CIRCUIT BREAKER IS DEAD CODE
     | File: src/risk/circuit_breaker.py (entire), all execution paths
     | CircuitBreaker is defined but NEVER called from:
     |   - PaperExecutionEngine
     |   - scripts/run_paper.py
     |   - scripts/run_backtest.py
     |   - BacktestEngine
     | The "last line of defense" per PLAN.md is completely unwired.

C-04 | NO TESTS FOR CIRCUIT BREAKER
     | File: tests/ (missing test_circuit_breaker.py entirely)
     | Zero test coverage for the most safety-critical component. Every state
     | transition, edge case, and race condition is untested.

C-05 | IRON CONDOR HAS NO EXIT CONDITIONS
     | File: src/strategies/iron_condor.py:54-55
     | get_exit_conditions() always returns None. PLAN.md 5.1 requires exits
     | on: 50% max profit, loss=premium received, DTE=1, regime change.
     | Only regime change exit is implemented (via on_regime_change).
     | Positions will be held indefinitely.

C-06 | OPTIONS VALUED AT UNDERLYING PRICE
     | File: src/backtest/engine.py:114
     | equity = cash + (position_qty * close_price)
     | For options, position_qty * underlying_close (~22000) instead of
     | option_premium (~100-200). Entire equity curve is meaningless for
     | any options strategy.

C-07 | CLASSIFIER NaN PROPAGATION — SILENT WRONG CLASSIFICATION
     | File: src/regime/classifier.py:117-202
     | If india_vix or adx_14 is NaN, all float comparisons return False.
     | The classifier silently falls through to "lean toward previous regime"
     | instead of raising an error or returning UNKNOWN.
     | FIX: Add NaN validation at top of classify().

C-08 | RACE CONDITION ON METADATA.JSON
     | File: src/data/store.py:26-32,155-174
     | _load_metadata() and _save_metadata() have no file locking. Concurrent
     | reads/writes (e.g., downloader + backtest) corrupt the metadata file.
     | FIX: Use fcntl.flock() or atomic write (write-to-temp + rename).

C-09 | KITECONNECT IMPORT BLOCKS ENTIRE DATA PACKAGE
     | File: src/data/__init__.py:17,28 and src/data/kite_feed.py:11
     | `from kiteconnect import KiteConnect` at module level means
     | `import src.data` fails if kiteconnect is not installed. This blocks
     | FreeFeed, DataStore, quality checks — everything.
     | FIX: Make kiteconnect a lazy import or optional dependency.

C-10 | NO MONTE CARLO / ANTI-OVERFITTING CHECKS
     | Files: entire codebase — not implemented anywhere
     | PLAN.md 4.6 requires: Monte Carlo permutation test, parameter
     | sensitivity analysis, cross-instrument validation, minimum 50-trade
     | enforcement. None exist.

C-11 | NO GRACEFUL SHUTDOWN IN PAPER TRADING LOOP
     | File: scripts/run_paper.py (entire)
     | No SIGINT/SIGTERM handler. systemd stop would interrupt mid-execution
     | with no cleanup, no state dump, and potential data corruption.

================================================================================
4. HIGH FINDINGS
================================================================================

── DATA LAYER ──

H-01 | DataStore reads ALL parquet partitions into memory
     | File: src/data/store.py:129-130
     | read_time_series loads every yearly partition even for narrow date
     | queries. 5 years of 1-min data = hundreds of MB loaded for 1-day query.

H-02 | _count_rows reads every parquet file to count rows
     | File: src/data/store.py:176-181
     | After writing, reads ALL files just to count. Use pyarrow metadata.

H-03 | Metadata inconsistency on crash between write and update
     | File: src/data/store.py:99-110
     | If process crashes after writing parquet but before metadata update,
     | metadata becomes stale. Write + metadata should be atomic.

H-04 | NseFiiClient.session never closed — connection leak
     | File: src/data/fii.py:25
     | requests.Session() created but no close/context-manager support.

H-05 | NSE API requires cookie session — current code gets 403
     | File: src/data/fii.py:40-56
     | Must visit base URL first to set cookies. Direct API call fails.

H-06 | Holiday list must be manually maintained annually
     | File: src/data/calendar.py:9-73
     | No validation, no warning if current year is missing. Running in 2027
     | without update = false-positive quality alerts for every holiday.

H-07 | No tests for FreeFeed, KiteFeed, or TrueDataFeed
     | Files: tests/ — no test files for any feed implementation
     | Zero test coverage for the primary data acquisition layer.

H-08 | kiteconnect is a hard dependency in pyproject.toml
     | File: pyproject.toml:14
     | Should be optional: [project.optional-dependencies] kite = [...]

── REGIME & SIGNALS ──

H-09 | get_regime_duration_days() uses datetime.now() — breaks replay
     | File: src/regime/classifier.py:255
     | Wall-clock time in a replayable classifier. During backtests this
     | returns meaningless values.

H-10 | O(n^2) performance in regime replay
     | File: src/regime/replay.py:42-67
     | For each bar, recomputes ADX/SMA from scratch on growing slice.
     | 1000 bars = ~500,000 cumulative rows processed.
     | FIX: Pre-compute ADX/SMA once (they're causal), index per bar.

H-11 | Supertrend uses Python for-loop — extremely slow
     | File: src/signals/trend.py:54-70
     | For-loop with .iloc access over every bar. Should be vectorized.

H-12 | Hardcoded thresholds in composite signals duplicate config
     | File: src/signals/composite.py:9,23
     | boring_alpha_setup uses hardcoded 20/14/0.8/1.2 instead of reading
     | from RegimeThresholds. Config drift risk.

H-13 | Nifty-BankNifty correlation feature is dead code
     | File: src/signals/regime.py:22,72
     | Default 0.95 is always used (never computed). Correlation breakdown
     | detection (classifier.py:189) never fires. Entire feature is inert.

── STRATEGIES & BACKTEST ──

H-14 | Engine never calls get_exit_conditions()
     | File: src/backtest/engine.py (entire)
     | PLAN.md 4.1 step 4: "call strategy.get_exit_conditions()". Not done.

H-15 | Single position_qty model broken for multi-leg options
     | File: src/backtest/engine.py:60,106-111
     | Iron condor (2 sells + 2 buys) nets to position_qty=0. Equity
     | curve ignores open option positions entirely.

H-16 | Sharpe ratio missing risk-free rate
     | File: src/backtest/metrics.py:18-27
     | PLAN.md requires "risk-free rate = India 10Y bond yield, ~7%".
     | Current implementation uses rf=0.

H-17 | Sharpe uses population std (ddof=0) — inflates ratio
     | File: src/backtest/metrics.py:24
     | Standard practice is ddof=1 (sample std).

H-18 | Sortino ratio not implemented
     | File: src/backtest/metrics.py (missing entirely)
     | PLAN.md core metric. Not implemented.

H-19 | Missing: annualized return, win rate, profit factor, Calmar ratio,
     | avg holding period, monthly returns table
     | File: src/backtest/metrics.py
     | 7 of 10 core metrics from PLAN.md 4.5 are not implemented.

H-20 | Walk-forward execution loop missing — only window generation exists
     | File: src/backtest/walkforward.py
     | No code to run the engine on each fold or compare in-sample vs OOS.

H-21 | No DTE handling in iron condor
     | File: src/strategies/iron_condor.py (entire)
     | Never checks DTE for entry (PLAN: 5-14 DTE) or exit (PLAN: close
     | at DTE=1). Positions can be held through expiry.

H-22 | Iron condor fallback legs use placeholder symbols at underlying price
     | File: src/strategies/iron_condor.py:122-137
     | When option chain is empty, legs named "NIFTY_CALL_SHORT" priced at
     | underlying close (~22000) instead of option premium (~100).

── EXECUTION & RISK ──

H-23 | Paper executor has no position tracking
     | File: src/execution/paper_executor.py (entire)
     | PLAN.md 6.1: "Tracks positions, P&L, margins in real-time."
     | Paper executor is purely a fill logger. No portfolio state.

H-24 | Paper executor no circuit breaker integration
     | File: src/execution/paper_executor.py (entire)
     | Signals execute unconditionally. No can_trade() check.

H-25 | VIX used as fallback option price in paper executor
     | File: src/execution/paper_executor.py:114-115
     | When order has no price, falls back to max(1.0, vix_hint). VIX (10-25)
     | used as option premium is semantically wrong.

H-26 | Circuit breaker WARNING state is sticky — never auto-clears
     | File: src/risk/circuit_breaker.py:201-216
     | Once in WARNING, never reverts to NORMAL even if PnL recovers.

H-27 | Daily auto-reset contradicts PLAN.md philosophy
     | File: src/risk/circuit_breaker.py:218-224
     | TRIPPED_DAILY silently resets at midnight. PLAN.md says manual review.

H-28 | Missing risk controls from PLAN.md
     | File: src/risk/circuit_breaker.py
     | Not implemented: per-position 5% cap, VIX>22 block, regime transition
     | block, HIGH_VOL_CHOPPY size reduction, exchange-level stop-loss.

H-29 | No circuit breaker state persistence
     | File: src/risk/circuit_breaker.py
     | Process restart = all breaker state lost. KILLED becomes NORMAL.

H-30 | Circuit breaker not thread-safe
     | File: src/risk/circuit_breaker.py:104-137
     | No locking on state mutations. WebSocket tick thread + order thread
     | can race on state.

── SCRIPTS ──

H-31 | run_paper.py swallows ALL exceptions and continues
     | File: scripts/run_paper.py:241
     | `except Exception as exc: print(...)` — loses stack trace, catches
     | MemoryError/SystemExit, continues trading after failures.

H-32 | run_paper.py has NoOpStrategy — cannot actually paper trade
     | File: scripts/run_paper.py:39-59
     | Every strategy is replaced with NoOpStrategy (always NO_SIGNAL).

H-33 | run_paper.py has no circuit breaker
     | File: scripts/run_paper.py (entire)
     | CircuitBreaker never instantiated or checked.

H-34 | Health check partially discloses credentials
     | File: scripts/health_check.py:72,95
     | Prints first 3-4 chars of credentials to stdout.

H-35 | All scripts use sys.path.insert hack
     | File: scripts/*.py
     | 6 scripts manually manipulate sys.path. Should use pip install -e.

── PROJECT ──

H-36 | truedata_ws not in pyproject.toml dependencies
     | File: pyproject.toml vs src/data/truedata_feed.py:52-56
     | Import exists but dependency not declared. Silent failure at runtime.

H-37 | TrueDataFeed tries 5 constructor signatures blindly
     | File: src/data/truedata_feed.py:84-103
     | Wrong combination could succeed silently with misconfigured client.

H-38 | option_dtos_from_chain result discarded in KiteFeed and TrueDataFeed
     | File: src/data/kite_feed.py:235, src/data/truedata_feed.py:310
     | Validation-by-side-effect. Return value thrown away.

================================================================================
5. MEDIUM FINDINGS
================================================================================

── DATA LAYER ──

M-01 | No OHLC invariant validation on Candle model
     | File: src/data/schemas.py:52-59
     | Accepts high < low, negative prices. Add @model_validator.

M-02 | Floating-point equality in get_by_strike
     | File: src/data/schemas.py:114-119
     | c.strike == strike — fails on epsilon differences across providers.

M-03 | CandleRequest defined but never used
     | File: src/data/feed.py:15
     | Protocol methods take separate args, not CandleRequest.

M-04 | DataStore creates dirs on read (side effect)
     | File: src/data/store.py:41
     | _dataset_dir calls mkdir unconditionally. Muddies existence checks.

M-05 | No retry logic on NSE API transient failures
     | File: src/data/fii.py:45-52
     | 429/503/timeouts cause hard failures. Use tenacity.

M-06 | normalize_fii_payload crashes on non-numeric strings
     | File: src/data/fii.py:74
     | NSE returns "-" or "N/A" for provisional data. float() throws.

M-07 | FreeFeed timestamp normalization converts IST to UTC incorrectly
     | File: src/data/free_feed.py:96
     | Strips timezone after converting to UTC = timestamps 5.5h behind.

M-08 | yfinance intraday chunk span too large for 1m data
     | File: src/data/free_feed.py:137
     | 58-day chunks work for 5m but 1m data limited to 7 days.

M-09 | KiteFeed instrument lookup is O(n) linear scan
     | File: src/data/kite_feed.py:76-96
     | Scans 10K+ instruments per request. Build dict on first load.

M-10 | KiteFeed returns underlying_price=0.0 for unknown symbols
     | File: src/data/kite_feed.py:165-171
     | Corrupts ATM strike calculations and delta-based leg selection.

M-11 | KiteFeed change_in_oi uses oi_day_high as placeholder
     | File: src/data/kite_feed.py:224
     | Known incorrect per TODO comment. Feeds wrong data to analysis.

M-12 | No error handling on Kite API calls
     | File: src/data/kite_feed.py:137-143
     | Token expiry mid-day crashes the system.

M-13 | TrueDataFeed falls back to UTC now() for missing expiry
     | File: src/data/truedata_feed.py:230-235
     | Option "expires right now" distorts time-to-expiry calculations.

M-14 | data_quality thresholds_by_timeframe config is dead code
     | File: config/settings.yaml:178-182
     | Defined but never consumed by quality.py.

── REGIME ──

M-15 | ADX smoothing state leaks across replays
     | File: src/regime/classifier.py:272-278
     | No reset() method. Reusing classifier for multiple replays
     | starts with leaked state from previous run.

M-16 | Classifier doesn't validate threshold relationships
     | File: src/regime/classifier.py:67-85
     | No check that vix_low < vix_high or adx_ranging < adx_trending.

M-17 | Snapshots list grows unbounded in memory
     | File: src/regime/classifier.py:201
     | Long-running sessions / large backtests exhaust memory.

M-18 | VIX slicing in replay may have lookahead for intraday
     | File: src/regime/replay.py:46-48
     | EOD VIX timestamps included for intraday candle timestamps.

M-19 | Option chain lookup uses exact datetime matching
     | File: src/regime/replay.py:53
     | Microsecond differences cause silent None returns.

── SIGNALS ──

M-20 | EMA crossover fires from bar 0 (no warm-up guard)
     | File: src/signals/trend.py:19-23
     | adjust=False starts EMA at first value. Signal unreliable for first
     | `slow` bars. Can trigger trades during warm-up.

M-21 | Supertrend initial direction defaults to bullish
     | File: src/signals/trend.py:52
     | Always starts direction=1 regardless of price action. Introduces bias.

M-22 | VWAP has no session reset — wrong for multi-day data
     | File: src/signals/mean_reversion.py:37-41
     | Cumulative VWAP drifts toward mean over multiple days.

M-23 | historical_volatility uses ddof=0 (population std)
     | File: src/signals/volatility.py:21
     | Underestimates volatility by ~2.5% for 20-day window.

M-24 | composite_regime_score doesn't renormalize when fii_z is None
     | File: src/signals/regime_filters.py:40-42
     | Score maxes at 0.8 instead of 1.0 when FII data unavailable.

M-25 | put_call_ratio returns 0.0 when call OI is zero
     | File: src/signals/options_signals.py:28
     | Semantically wrong — "no calls" is extreme bullish, not 0.0.

M-26 | max_pain O(S*N) performance
     | File: src/signals/options_signals.py:42-50
     | Iterates all strikes × full chain. Should vectorize.

M-27 | fii_direction uses .apply(lambda) instead of np.sign
     | File: src/signals/volume_flow.py:23
     | Orders of magnitude slower than vectorized alternative.

M-28 | rolling_correlation min_periods=1 is meaningless
     | File: src/signals/regime_filters.py:31
     | Single-pair correlation is always +/-1. Set min_periods=window.

M-29 | build_regime_signals uses magic number 28 for ADX warm-up
     | File: src/signals/regime.py:36
     | Should be 2*period+1 and not hardcoded.

── STRATEGIES ──

M-30 | Silent swallowing of unknown regime strings in _parse_active_regimes
     | File: src/strategies/base.py:110
     | Typo in config = strategy never trades, no warning logged.

M-31 | datetime.now() scattered across strategy code (5 files)
     | Files: base.py:185, iron_condor.py:16,89, regime_probe.py:14,
     | momentum.py:17, router.py:26
     | Injects wall-clock time in backtest mode.

M-32 | Iron condor no entry premium tracking — can't compute profit target
     | File: src/strategies/iron_condor.py:29-34
     | current_position stores structure but no entry_premium/max_profit.

M-33 | MomentumStrategy position flip doubles quantity inconsistency
     | File: src/strategies/momentum.py:69-99
     | Engine processes 2 sells (total 2*qty) but strategy sets qty.

M-34 | MomentumStrategy get_exit_conditions returns None
     | File: src/strategies/momentum.py:103-104
     | PLAN.md: "ATR-based trailing stop (2x ATR)". Not implemented.

M-35 | Router doesn't notify strategy of within-active-set regime changes
     | File: src/strategies/router.py:32-53
     | Strategy can't react to regime shifts within its active regimes.

── BACKTEST ──

M-36 | Engine _next_signal calls on_regime_change every inactive bar
     | File: src/backtest/engine.py:139-150
     | Should only fire on transition bar, not every bar of inactivity.

M-37 | No circuit breaker check in engine
     | File: src/backtest/engine.py (entire)
     | PLAN.md 4.1 step 7. Not implemented.

M-38 | Engine supports only single strategy
     | File: src/backtest/engine.py:27
     | PLAN.md 4.1: "multiple strategies running simultaneously".

M-39 | HTML report has no charts
     | File: src/backtest/report.py
     | PLAN.md: "equity curve, drawdown, monthly heatmap". Only table.

M-40 | _render_html crashes on non-float metric values
     | File: src/backtest/report.py:77
     | f"{v:.6f}" throws ValueError on strings or None.

── EXECUTION ──

M-41 | fill_id not globally unique (resets on restart)
     | File: src/execution/paper_executor.py:83
     | PAPER-00000001 collides across restarts. Use UUID.

M-42 | Slippage model too simplistic for production paper trading
     | File: src/execution/paper_executor.py:117-121
     | Fixed bps regardless of order size, spread, volatility.

M-43 | Paper executor has zero logging
     | File: src/execution/paper_executor.py (entire)
     | PLAN.md Architecture Principle 4: "Log everything with context."

M-44 | EXIT signal always maps to SELL regardless of position side
     | File: src/execution/paper_executor.py:101-106
     | Short exit should BUY to cover.

── RISK ──

M-45 | Circuit breaker date.today() not timezone-aware
     | File: src/risk/circuit_breaker.py:77,120,220
     | UTC server = day boundary at 5:30 AM IST, not midnight.

M-46 | peak_equity never decreases after reset
     | File: src/risk/circuit_breaker.py:127
     | Reset with reduced capital = immediate drawdown from old peak.

M-47 | TRIPPED_DAILY can be overwritten by TRIPPED_DRAWDOWN
     | File: src/risk/circuit_breaker.py:178-199
     | Transition not logged as such.

── SCRIPTS ──

M-48 | run_paper.py uses print() instead of structlog
     | File: scripts/run_paper.py (entire)
     | Project has structlog as dependency. Not used.

M-49 | run_paper.py slippage unit ambiguous (pct vs decimal)
     | File: scripts/run_paper.py:172-173
     | 0.05 could mean 0.05% or 5%. Naming is confusing.

M-50 | run_backtest.py no exception handling in main()
     | File: scripts/run_backtest.py:92-245
     | Crashes lose partial results. No cleanup.

M-51 | run_backtest.py silently passes empty option chain to engine
     | File: scripts/run_backtest.py:121-127
     | No warning when option chain data is missing.

M-52 | health_check.py no timeout on network calls
     | File: scripts/health_check.py:134-138,157-159
     | Hung DNS = blocked indefinitely.

M-53 | download_historical.py returns 0 even on partial failure
     | File: scripts/download_historical.py:161
     | 5/6 downloads fail = still "success". Masks issues in CI.

── PROJECT STRUCTURE ──

M-54 | 5 root-level .py files are wildcard re-export shims
     | Files: base.py, circuit_breaker.py, classifier.py, schemas.py,
     | health_check.py
     | Creates two import paths for every class. Remove or use explicit.

M-55 | src/risk/__init__.py is empty — doesn't export CircuitBreaker
     | File: src/risk/__init__.py
     | Must import from submodule. Inconsistent with other packages.

M-56 | strategies/__init__.py missing exports for main strategies
     | File: src/strategies/__init__.py:7-15
     | MomentumStrategy and IronCondorStrategy not in __all__.

M-57 | openchart==0.2.0 exact pin vs yfinance>=0.2 range — inconsistent
     | File: pyproject.toml:10

M-58 | jugaad-data not in pyproject.toml
     | File: pyproject.toml
     | Imported in free_feed.py but not declared as dependency.

M-59 | Credentials stored as plain strings in feed dataclasses
     | Files: src/data/kite_feed.py:25-26, truedata_feed.py:37-38
     | repr/print exposes API keys.

M-60 | NormalizedCandleDTO.volume is float but Candle.volume is int
     | File: src/data/contracts.py:18-19
     | Type mismatch between DTO and schema.

M-61 | candle_dtos_from_frame doesn't reject NaN OHLC
     | File: src/data/contracts.py:76-91
     | float(NaN) accepted silently. Downstream produces NaN results.

M-62 | pd.Timestamp.to_pydatetime() deprecation warning
     | Files: src/data/contracts.py:77,157, src/regime/replay.py:43
     | Will error in pandas 3.0.

================================================================================
6. LOW FINDINGS (Selected — 45 total, showing key items)
================================================================================

L-01 | get_atm_strike hardcodes step=50 (NIFTY only)
     | src/data/schemas.py:121

L-02 | pcr returns 0.0 when call_oi=0 in schemas.py
     | src/data/schemas.py:132-138

L-03 | Order.quantity accepts zero or negative
     | src/data/schemas.py:150

L-04 | DataStore base_dir is relative path
     | src/data/store.py:17

L-05 | Deduplication overwrites corrected data silently
     | src/data/store.py:84-91

L-06 | NSE User-Agent hardcoded to specific Chrome version
     | src/data/fii.py:27-31

L-07 | FreeFeed._jugaad_daily rename fails silently on wrong columns
     | src/data/free_feed.py:162-189

L-08 | No schema versioning on parquet files
     | src/data/store.py

L-09 | Classifier cold-start asymmetry (UNKNOWN initial regime)
     | src/regime/classifier.py:280-311

L-10 | RegimeSignals defaults (nifty_above_50dma=True) misleading
     | src/regime/classifier.py:44-46

L-11 | trend.adx() no input alignment validation
     | src/signals/trend.py:26-28

L-12 | historical_volatility no guard on zero/negative close
     | src/signals/volatility.py:20

L-13 | iv_surface_tilt median strike as underlying proxy
     | src/signals/options_signals.py:99

L-14 | _normalize_iv_chain drops non-CE/PE silently
     | src/signals/options_signals.py:14

L-15 | StrategyState.realized_pnl and consecutive_losses never updated
     | src/strategies/base.py:190-192

L-16 | Circuit breaker trip_history grows unbounded
     | src/risk/circuit_breaker.py:228

L-17 | download_fii_dii.py no backup before CSV overwrite
     | scripts/download_fii_dii.py:69-83

L-18 | data_quality_report.py relative_to(REPO_ROOT) crash on abs paths
     | scripts/data_quality_report.py:119

L-19 | scripts/__init__.py makes scripts a Python package (shouldn't be)
     | scripts/__init__.py

L-20 | No partial fill simulation
     | src/backtest/simulator.py (PLAN.md 4.2 mentions this)

================================================================================
7. TEST COVERAGE GAPS
================================================================================

CRITICAL MISSING TEST FILES:
  [ ] tests/test_risk/test_circuit_breaker.py — ZERO coverage
  [ ] tests/test_data/test_free_feed.py — ZERO coverage
  [ ] tests/test_data/test_kite_feed.py — ZERO coverage
  [ ] tests/test_data/test_truedata_feed.py — ZERO coverage
  [ ] tests/test_data/test_calendar.py — ZERO coverage
  [ ] tests/test_data/test_schemas.py — ZERO coverage

MISSING TEST SCENARIOS (by module):

  Regime Classifier:
  [ ] NaN input handling
  [ ] UNKNOWN initial regime cold-start
  [ ] Classifier reuse/reset across replays
  [ ] get_regime_duration_days()
  [ ] FII selling override path
  [ ] Correlation breakdown detection

  Signals:
  [ ] Supertrend (not tested at all)
  [ ] zscore, vwap, vwap_deviation_atr
  [ ] volume_spike, fii_net_rolling, fii_direction
  [ ] composite_regime_score
  [ ] rolling_correlation
  [ ] historical_volatility, atr_pct
  [ ] breakout_confirmation with breakout data
  [ ] Empty DataFrame inputs for signal functions

  Strategies:
  [ ] Iron condor with real option chain (delta-based selection end-to-end)
  [ ] Iron condor second call returns NO_SIGNAL
  [ ] Iron condor exit conditions
  [ ] Momentum position flip (ADJUST signals)
  [ ] Momentum ADX filter rejection
  [ ] Multiple strategies in router

  Backtest:
  [ ] SELL side slippage in simulator
  [ ] Multiple orders in one signal
  [ ] max_drawdown_pct independently with known values
  [ ] sharpe_ratio with known returns
  [ ] regime_segmented_returns
  [ ] Empty/single-row equity curves
  [ ] Engine with empty candles
  [ ] Engine regime transition mid-backtest
  [ ] Walk-forward edge cases

  Execution:
  [ ] ENTRY_SHORT signal handling
  [ ] EXIT signal handling
  [ ] Multiple signals in single call
  [ ] Missing price fallback
  [ ] Persistence failure scenarios

  Data:
  [ ] Concurrent store writes
  [ ] Date-filtered reads
  [ ] Empty DataFrame writes
  [ ] Corrupted parquet files
  [ ] Cross-year data partitioning
  [ ] DataFeed protocol conformance
  [ ] NaN values in candle DataFrames
  [ ] FII normalize with empty payload
  [ ] Malformed date strings

================================================================================
8. PLAN.MD COMPLIANCE AUDIT
================================================================================

Phase 1 — Data Pipeline:
  [x] DataFeed protocol/interface
  [x] Data storage in Parquet
  [x] Data quality validation
  [x] FII/DII pipeline
  [ ] MISSING: scripts/download_historical.py (exists but incomplete)
  [ ] MISSING: Auto-download missing data on backtest request
  [ ] MISSING: Data quality report notebook (02_data_quality.ipynb)
  [ ] MISSING: Cross-source data comparison utility

Phase 2 — Signal Library:
  [x] Trend signals (EMA, ADX, supertrend)
  [x] Mean reversion signals (RSI, Bollinger, z-score, VWAP)
  [x] Volatility signals (VIX, ATR, IV rank)
  [x] Volume/flow signals (OBV, FII)
  [x] Options signals (PCR, max pain, IV surface)
  [x] Regime filter signals
  [x] Composite signals
  [ ] MISSING: Signal exploration notebook (03_signal_exploration.ipynb)

Phase 3 — Regime Classifier:
  [x] Four regime classification
  [x] Hysteresis + smoothing
  [x] Override signals (FII, VIX spike)
  [x] Historical replay (no lookahead)
  [x] Regime transition logging
  [ ] PARTIAL: Correlation breakdown detection (dead code)
  [ ] MISSING: Regime analysis notebook

Phase 4 — Backtesting Engine:
  [x] Event-driven architecture
  [x] Walk-forward window generation
  [x] Basic fill simulation
  [x] Basic metrics (Sharpe, max drawdown)
  [x] Report generation (JSON, HTML, CSV)
  [ ] MISSING: Full Indian cost model (5 of 7 components)
  [ ] MISSING: Sortino, Calmar, profit factor, win rate, avg holding
  [ ] MISSING: Monthly returns table
  [ ] MISSING: Charts in HTML report
  [ ] MISSING: get_exit_conditions() in engine loop
  [ ] MISSING: Circuit breaker in engine
  [ ] MISSING: Multi-strategy support
  [ ] MISSING: Walk-forward execution loop
  [ ] MISSING: Monte Carlo permutation test
  [ ] MISSING: Parameter sensitivity analysis
  [ ] MISSING: Cross-instrument validation
  [ ] MISSING: Minimum 50-trade enforcement

Phase 5 — Strategies (in progress):
  [x] Iron condor structure (entry logic)
  [x] Momentum EMA crossover
  [ ] MISSING: Iron condor exit conditions (50% profit, max loss, DTE=1)
  [ ] MISSING: Iron condor DTE-based entry filter
  [ ] MISSING: Momentum trailing stop
  [ ] MISSING: RSI mean reversion strategy (referenced in config)
  [ ] MISSING: Expiry day theta decay strategy

Phase 6 — Paper Trading:
  [x] Paper executor scaffold
  [x] run_paper.py scaffold
  [ ] MISSING: Position/portfolio tracking
  [ ] MISSING: Circuit breaker integration
  [ ] MISSING: Structured logging
  [ ] MISSING: Telegram alerts
  [ ] MISSING: Streamlit dashboard
  [ ] MISSING: Real strategy (NoOp placeholder)

================================================================================
9. ARCHITECTURE & DESIGN ISSUES
================================================================================

A-01 | SEPARATION OF CONCERNS VIOLATION
     | FreeFeed.get_fii_data mixes data sourcing with caching (constructs
     | file paths, calls load_or_fetch_fii_dii). DataStore should handle
     | caching; feed should only fetch.

A-02 | "SAME CODE PATH" PRINCIPLE NOT ACHIEVABLE
     | The backtest engine (src/backtest/engine.py) and paper executor
     | (src/execution/paper_executor.py) have completely different interfaces
     | and data flow. There is no shared execution abstraction that lets the
     | same strategy code run identically in both modes.

A-03 | FAIL-SAFE PRINCIPLE VIOLATED
     | - Classifier silently classifies with NaN inputs (should raise/UNKNOWN)
     | - Circuit breaker is dead code (should be mandatory)
     | - Paper executor fills without risk check (should require can_trade())
     | - Missing data produces empty results (should warn or block)

A-04 | CONFIG OVER CODE PRINCIPLE VIOLATED
     | Hardcoded values found in:
     |   - composite.py: ADX=20, VIX=14, PCR 0.8-1.2, VIX change=3.0
     |   - schemas.py: step=50 for ATM strike
     |   - signals/regime.py: ADX warm-up=28
     |   - calendar.py: holiday lists (should be config or fetched)

A-05 | LOG EVERYTHING PRINCIPLE VIOLATED
     | Paper executor: zero logging
     | Scripts: print() instead of structlog
     | Strategy signals: no structured logging of signal context
     | Circuit breaker trips: only trip_history list, no log emission

================================================================================
10. RECOMMENDED FIX PRIORITY
================================================================================

PRIORITY 1 — Fix before any testing with real data:
  C-01  Fix backtest lookahead bias
  C-02  Implement full Indian cost model
  C-06  Fix options equity valuation
  H-15  Fix multi-leg position tracking
  H-16  Add risk-free rate to Sharpe
  H-17  Fix ddof=1 for Sharpe

PRIORITY 2 — Fix before paper trading:
  C-03  Wire circuit breaker into execution paths
  C-04  Write circuit breaker tests
  C-05  Implement iron condor exit conditions
  C-07  Add NaN validation to classifier
  C-11  Add graceful shutdown to paper loop
  H-23  Add position tracking to paper executor
  H-32  Replace NoOpStrategy with real strategies

PRIORITY 3 — Fix before Phase 5 completion:
  C-10  Implement Monte Carlo / anti-overfitting checks
  H-14  Call get_exit_conditions() in engine
  H-18  Implement Sortino ratio
  H-19  Implement remaining core metrics
  H-20  Implement walk-forward execution loop
  H-21  Add DTE handling to iron condor

PRIORITY 4 — Fix before production:
  C-08  Add file locking to DataStore
  C-09  Make kiteconnect a lazy/optional import
  H-05  Fix NSE FII client cookie handling
  H-06  Make calendar auto-updating or warn on missing years
  H-07  Add feed tests (mocked)
  H-30  Add thread safety to circuit breaker
  H-29  Persist circuit breaker state

PRIORITY 5 — Quality improvements:
  All MEDIUM and LOW findings
  Test coverage expansion per Section 7
  Architecture alignment per Section 9

================================================================================
END OF REVIEW
================================================================================
