# ============================================================
# NiftyQuant Settings
# All strategy parameters and risk limits live here.
# Changing a parameter should NEVER require a code change.
# ============================================================

# strategy:   # early exit
#   iron_condor:
#     entry_day: "Monday"          # or Tuesday if Monday is holiday
#     exit_rules:
#       profit_target_pct: 50      # exit at 50% of max premium captured
#       time_exit_day: "Wednesday"
#       time_exit_time: "15:00"    # 3 PM — 30 min before close
#       stop_loss_pct: 100         # exit if loss equals premium received
#     hold_through_expiry: false   # THE KEY SETTING

# === Market Hours (IST) ===
market:
  exchange: NSE
  open_time: "09:15"
  close_time: "15:30"
  usdinr_symbol: "USDINR"
  pre_open_start: "09:00"
  # Signal clocks
  decision_timeframe: "15m"       # Primary strategy decision cadence
  defensive_check_timeframe: "5m" # Faster cadence for protective exits/risk checks
  # Entry window controls
  last_new_entry_time: "15:15"    # No fresh entries after this IST time
  # Don't place orders in first/last N minutes (volatile periods)
  entry_buffer_minutes: 15
  exit_buffer_minutes: 10

# === Regime Classifier ===
regime:
  # VIX thresholds
  vix_low: 14.0
  vix_high: 18.0

  # ADX thresholds (14-period on Nifty daily)
  adx_trending: 25.0
  adx_ranging: 20.0

  # FII flow alert (crore INR, 3-day cumulative)
  fii_selling_alert: -6000

  # Put-Call Ratio extremes
  pcr_oversold: 0.7
  pcr_overbought: 1.3
  corr_breakdown: 0.80

  # Stress alerts (used as classifier overrides)
  vix_spike_5d_alert: 3.0
  iv_surface_shift_alert: 2.0
  iv_surface_tilt_alert: 1.5

  # Stability controls (Phase 3)
  vix_hysteresis_buffer: 0.5
  adx_hysteresis_buffer: 2.0
  adx_smoothing_alpha: 0.3

  # States: low_vol_trending | low_vol_ranging | high_vol_trending | high_vol_choppy
  # Each strategy declares which regimes it's active in

# === Risk Management (Global) ===
risk:
  # Baseline account capital for paper/live risk accounting
  initial_capital: 150000

  # Maximum daily loss as % of capital — triggers circuit breaker
  max_daily_loss_pct: 3.0

  # Maximum drawdown from peak — stops all trading until manual reset
  max_drawdown_pct: 15.0

  # Maximum % of capital in any single position
  max_position_pct: 5.0

  # Portfolio margin utilization operating band
  margin_utilization_min_pct: 20.0
  margin_utilization_max_pct: 40.0

  # Maximum number of concurrent open positions
  max_open_positions: 4

  # Kill switch — if True, no orders placed regardless of signals
  kill_switch: false

# === Strategies ===
strategies:

  iron_condor:
    enabled: true
    instrument: NIFTY
    active_regimes:
      - low_vol_ranging
      - low_vol_trending  # with tighter strikes
    # Entry parameters
    call_delta: 0.15        # Sell call at ~15 delta
    put_delta: -0.15        # Sell put at ~15 delta
    wing_width: 100         # Points between sold and bought strikes
    dte_min: 5              # Minimum days to expiry at entry
    dte_max: 14             # Maximum days to expiry at entry
    min_entry_vix: 9.0      # Skip if implied vol is too compressed
    max_entry_vix: 16.0     # Skip if implied vol is too elevated
    atr_multiple: 1.5       # Short strike distance from spot in ATR units
    min_premium: 15.0       # Minimum expected net credit per unit
    entry_days: [0, 1]      # 0=Monday, 1=Tuesday
    # Exit parameters
    profit_target_pct: 50   # Close at 50% of max profit
    stop_loss_pct: 100      # Close if loss equals premium received
    dte_exit: 1             # Close if DTE drops to 1 (avoid expiry risk)
    # Position sizing
    max_lots: 2
    capital_per_trade: 150000

  jade_lizard:
    enabled: false
    instrument: NIFTY
    active_regimes:
      - low_vol_ranging
      - low_vol_trending
    variant: neutral         # neutral | bullish | bearish
    neutral_fallback: bullish
    call_delta: 0.15
    put_delta: -0.15
    spread_width: 100
    dte_min: 5
    dte_max: 14
    min_entry_credit: 10.0
    profit_target_pct: 50
    stop_loss_pct: 100
    dte_exit: 1
    max_lots: 2
    capital_per_trade: 150000

  straddle:
    enabled: false
    instrument: NIFTY
    active_regimes:
      - low_vol_ranging
    variant: short            # short | long
    delta_target: 0.50        # ATM proxy for call/put strike selection
    dte_min: 5
    dte_max: 14
    min_entry_vix: 11.0
    max_entry_vix: 22.0
    profit_target_pct: 35
    stop_loss_pct: 120
    dte_exit: 1
    max_lots: 1
    capital_per_trade: 150000

  credit_spread:
    enabled: false
    instrument: BANKNIFTY
    active_regimes:
      - low_vol_ranging
    direction: neutral      # bull_put | bear_call | neutral (both)
    delta: 0.20
    spread_width: 200
    dte_min: 3
    dte_max: 7
    profit_target_pct: 40
    stop_loss_pct: 80
    max_lots: 2
    capital_per_trade: 150000

  momentum:
    enabled: false
    instrument: NIFTY
    active_regimes:
      - low_vol_trending
      - high_vol_trending
    fast_ema: 20
    slow_ema: 50
    adx_filter: 25          # Only enter if ADX > this
    atr_multiplier: 2.0     # Stop loss = ATR * this
    position_type: futures   # futures | options
    max_lots: 1
    capital_per_trade: 200000

  mean_reversion:
    enabled: false
    instrument: NIFTY
    active_regimes:
      - low_vol_ranging
    lookback_period: 20
    entry_zscore: 2.0       # Enter when z-score exceeds this
    exit_zscore: 0.5        # Exit when z-score reverts to this
    vwap_confirmation: true # Require VWAP alignment
    max_lots: 1
    capital_per_trade: 150000

# === Backtest Settings ===
backtest:
  # Default date range
  start_date: "2022-01-01"
  end_date: "2025-12-31"

  # Realistic cost modeling
  slippage_pct: 0.05        # 0.05% per side
  commission_per_order: 20  # Zerodha flat fee
  risk_free_rate_annual: 0.07  # Annualized risk-free rate for Sharpe/Sortino
  monte_carlo_permutations: 200  # Anti-overfitting permutation iterations
  minimum_trade_count: 50        # Minimum trades required for strategy acceptance
  sensitivity:
    enabled: false
    multipliers: [0.8, 1.0, 1.2]
    max_params_per_strategy: 3
    params_by_strategy:
      iron_condor: [call_delta, put_delta, wing_width]
      momentum: [fast_ema, slow_ema, atr_multiplier]
  vectorbt_fees_pct: 0.05   # Base vectorbt fee % (if omitted, slippage_pct is reused)
  vectorbt_fee_profiles:
    default: base
    profiles:
      base:
        slippage_multiplier: 1.0
        fee_multiplier: 1.0
      penalized:
        slippage_multiplier: 1.5
        fee_multiplier: 1.25
      stress:
        slippage_multiplier: 2.0
        fee_multiplier: 1.5
  vectorbt_promotion_gate:
    enabled: true
    min_trades_mean: 5
    min_metric_worst: 0.0
    min_metric_mean: 0.0
    max_drawdown_abs_worst: 12.0
    min_eligible_profile_share: 1.0
  stt_pct: 0.0125           # Securities Transaction Tax (sell side, options)
  exchange_txn_charges_pct: 0.053  # NSE F&O transaction charges
  gst_pct: 18.0             # GST on brokerage
  sebi_fee_pct: 0.0001      # SEBI turnover fee
  stamp_duty_pct: 0.003     # Stamp duty

  # Walk-forward configuration
  train_months: 12
  test_months: 3
  step_months: 3            # Roll forward by this much

# === Data Storage ===
data:
  # Where to cache downloaded historical data
  cache_dir: "data/cache"
  # Format: parquet | csv
  format: parquet
  # Auto-download missing data on backtest
  auto_download: true

# === Monitoring ===
monitoring:
  # How often to log portfolio state (seconds)
  heartbeat_interval: 60
  # Send Telegram alert on these events
  alert_on:
    - trade_executed
    - circuit_breaker_triggered
    - drawdown_warning       # At 10% drawdown, before 15% kill
    - api_error
    - regime_change

# === Ops / Runbook Gates ===
ops:
  freshness:
    candles_1d_max_age_minutes: 4320      # 3 days
    candles_runtime_max_age_minutes: 1440 # 1 day
    vix_1d_max_age_minutes: 4320          # 3 days
    fii_1d_max_age_minutes: 7200          # 5 days
    usdinr_1d_max_age_minutes: 4320       # 3 days
    signal_snapshots_max_age_minutes: 10080 # 7 days
    intraday_signal_max_age_minutes: 60
    intraday_regime_max_age_minutes: 60

# === Data Quality Gates ===
data_quality:
  thresholds:
    max_missing_timestamps: 0
    max_duplicate_timestamps: 0
    max_invalid_ohlc_rows: 0
    max_negative_or_zero_price_rows: 0
    max_non_monotonic_timestamps: 0
    max_missing_trading_days: 0
    max_largest_gap_minutes: null
  thresholds_by_timeframe:
    1d:
      max_largest_gap_minutes: 6000
    5m:
      max_largest_gap_minutes: 8000
